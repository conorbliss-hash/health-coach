# Fix for Main.js - Read from WeeklyRollups Instead of Raw Data

## Problem

The weekly report (generated by `Main.js`) calculates scores from raw Activity/Sleep/HeartRate tabs using partial week data, resulting in misleading scores like 49% readiness and 44% output on the first day of a new week.

## Solution

Modify `Main.js` to read the most recent **complete week** from the WeeklyRollups sheet instead of calculating from raw data.

## Changes Required

### 1. Add a new function to Data.js to read from WeeklyRollups

```javascript
/**
 * Get the most recent complete week data from WeeklyRollups sheet
 * @returns {Object} Latest complete week data, or null if none found
 */
function getLatestCompleteWeekFromRollups() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const ws = ss.getSheetByName('WeeklyRollups');
  
  if (!ws) {
    Logger.log('WeeklyRollups sheet not found');
    return null;
  }
  
  const data = ws.getDataRange().getValues();
  if (data.length <= 1) return null; // Only header row
  
  const headers = data[0];
  const rows = data.slice(1);
  
  // Find column indices
  const colIndex = {};
  headers.forEach((header, idx) => {
    colIndex[header] = idx;
  });
  
  // Filter for complete weeks (data_gaps = 0) and sort by week_start descending
  const completeWeeks = rows
    .map(row => {
      const obj = {};
      headers.forEach((header, idx) => {
        obj[header] = row[idx];
      });
      return obj;
    })
    .filter(row => row.data_gaps === 0 || row.data_gaps === '0')
    .sort((a, b) => {
      const dateA = new Date(a.week_start);
      const dateB = new Date(b.week_start);
      return dateB - dateA; // Descending
    });
  
  if (completeWeeks.length === 0) return null;
  
  return completeWeeks[0]; // Most recent complete week
}
```

### 2. Modify Main.js weeklyReportJob() function

Replace this section (around line 452):

```javascript
// OLD CODE - Reading from raw tabs
stage = 'load_weekly_data';
logWeeklyJob_('weekly_job:stage', { stage });
const weekly = {
  steps:         getWeeklyAverageFromActivity('steps'),
  trainingLoad:  getWeeklySumFromActivity('volume_kg'),
  workHours:     getWeeklySumFromActivity('working hours'),
  prs:           getWeeklySumFromActivity('prs') || 0,
  sleep:         getWeeklyAverage('Sleep', 'sleep_total_min'),
  rhr:           getWeeklyAverage('HeartRate', 'resting_heart_rate')
};
```

With:

```javascript
// NEW CODE - Reading from WeeklyRollups
stage = 'load_weekly_data';
logWeeklyJob_('weekly_job:stage', { stage });

// Try to get from WeeklyRollups first
const latestRollup = getLatestCompleteWeekFromRollups();
let weekly;

if (latestRollup) {
  // Use data from WeeklyRollups (most recent complete week)
  logWeeklyJob_('weekly_job:using_rollups', { week: latestRollup.week_start });
  weekly = {
    steps:         latestRollup.steps_day_avg || null,
    trainingLoad:  latestRollup.gym_load_sum || null,
    workHours:     latestRollup.work_hours_sum || null,
    prs:           0, // Not in rollups, would need separate query
    sleep:         latestRollup.sleep_min_avg || null,
    rhr:           latestRollup.rhr_avg || null,
    sleepConsistency: {
      sdMinutes: latestRollup.sleep_sd_min,
      score: null,  // Would need to recalculate or store in rollups
      label: null
    },
    acwr: {
      value: latestRollup.acwr,
      ratio: latestRollup.acwr,
      label: null
    }
  };
} else {
  // Fallback to raw data calculation if no complete week in rollups
  logWeeklyJob_('weekly_job:fallback_to_raw', { reason: 'no_complete_rollup' });
  weekly = {
    steps:         getWeeklyAverageFromActivity('steps'),
    trainingLoad:  getWeeklySumFromActivity('volume_kg'),
    workHours:     getWeeklySumFromActivity('working hours'),
    prs:           getWeeklySumFromActivity('prs') || 0,
    sleep:         getWeeklyAverage('Sleep', 'sleep_total_min'),
    rhr:           getWeeklyAverage('HeartRate', 'resting_heart_rate')
  };
}
```

### 3. Update the compositeSummary section

Around line 495, ensure the compositeSummary uses the rollup data:

```javascript
const weeklyRollups = getWeeklyRollups_(8);
const compositeSummary = buildCompositeSummary_({
  weeklyRollups,
  weekly,
  goals: USER_GOALS,
  acwrValue: weekly.acwr?.value ?? weekly.acwr?.ratio ?? null,
  sleepConsistencySd: weekly.sleepConsistency?.sdMinutes ?? null,
  weekMeta
});
```

### 4. Add a note in the report when using rollup data

In the gapsNoteMsg section (around line 801), add:

```javascript
const gaps = [];
if (latestRollup) {
  // Show which week we're reporting on
  gaps.push(`Based on complete week ${latestRollup.week_start} to ${latestRollup.week_end}`);
} else {
  // Show data quality for current partial week
  if (derivedStats.missing.activity) gaps.push(`${derivedStats.missing.activity} missing (Activity)`);
  if (derivedStats.missing.sleep) gaps.push(`${derivedStats.missing.sleep} (Sleep)`);
  if (derivedStats.missing.rhr) gaps.push(`${derivedStats.missing.rhr} (RHR)`);
}
const gapsNoteMsg = gaps.length ? `Data Gaps: ${gaps.join('; ')} â€” trends may be noisy.` : '';
```

## Expected Behavior After Fix

### Saturday, Nov 8 (start of new week)
**Before Fix:**
- Report shows: Week of 2025-11-08
- Readiness: 49% (based on 1 day of data)
- Output: 44% (based on 1 day of data)

**After Fix:**
- Report shows: Week of 2025-11-08 (based on complete week 2025-11-01 to 2025-11-07)
- Readiness: 90% (based on 7 complete days)
- Output: 83% (based on 7 complete days)

### Throughout the Week (Sun-Fri)
- Scores remain consistent (still showing last complete week)
- Users see stable, reliable metrics
- No misleading partial-week scores

### Friday (week end)
- When the current week completes, next run will show the new week's scores

## Testing

1. Run `fit_to_sheets.py` to ensure WeeklyRollups has complete weeks
2. Verify `data_gaps = 0` for at least one recent week
3. Run the weekly report job manually
4. Confirm scores match the WeeklyRollups sheet
5. Check that "Based on complete week..." message appears

## Rollback Plan

If issues occur, the fallback code will automatically use raw data calculation when `getLatestCompleteWeekFromRollups()` returns null.
